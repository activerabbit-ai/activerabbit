<% content_for :page_title do %>
  Install ActiveRabbit Gem
<% end %>

<% non_rails_stack = @project.respond_to?(:tech_stack) && @project.tech_stack.present? && @project.tech_stack != 'rails' %>

<% if non_rails_stack %>
  <div class="max-w-3xl mx-auto mt-12">
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 shadow-sm">
      <div class="flex items-start">
        <div class="flex-shrink-0 mr-4">
          <span class="text-yellow-500 text-3xl leading-none">‚ö†Ô∏è</span>
        </div>
        <div>
          <h1 class="text-2xl font-bold text-yellow-900 mb-2">Stack support coming soon</h1>
          <p class="text-sm text-yellow-800 mb-3">
            ActiveRabbit fully supports Ruby on Rails today. We are working on native support for <strong><%= @project.tech_stack.to_s.titleize %></strong>.
          </p>
          <p class="text-sm text-yellow-800 mb-3">
            We will email <strong><%= current_user.email %></strong> as soon as <%= @project.tech_stack.to_s.titleize %> support is ready.
          </p>
          <p class="text-sm text-yellow-800">
            Want early access or to share requirements? Contact us at
            <a href="mailto:support@activerabbit.ai" class="underline text-yellow-900">support@activerabbit.ai</a>.
          </p>
        </div>
      </div>
    </div>
  </div>
<% else %>
<!-- Page Header -->
<div class="mb-8">
  <div>
    <h1 class="text-2xl font-bold text-gray-900">Install ActiveRabbit Gem</h1>
    <p class="text-gray-600 mt-1">
      <% if current_user.projects.count > 1 %>
        Add monitoring for "<%= @project.name %>" to your Rails application
      <% else %>
        Add monitoring to your Rails application
      <% end %>
    </p>
  </div>

  <!-- Error Messages -->
  <% if flash[:alert] %>
    <div class="mt-4 bg-red-50 border border-red-200 rounded-lg p-4">
      <div class="flex">
        <div class="flex-shrink-0">
          <span class="text-red-500 text-xl">‚ùå</span>
        </div>
        <div class="ml-4">
          <h3 class="text-sm font-medium text-red-800 mb-2">Verification Failed</h3>
          <p class="text-sm text-red-700 mb-3"><%= flash[:alert] %></p>

          <% if flash[:suggestions] %>
            <div class="text-sm text-red-700">
              <p class="font-medium mb-2">Troubleshooting suggestions:</p>
              <ul class="list-disc pl-5 space-y-1">
                <% flash[:suggestions].each do |suggestion| %>
                  <li><%= suggestion %></li>
                <% end %>
              </ul>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
</div>

<!-- Main Content -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
  <!-- Installation Instructions -->
  <div class="lg:col-span-2">
    <div class="bg-white rounded-lg shadow p-6">
      <div class="flex items-center mb-6">
        <span class="inline-flex items-center justify-center h-10 w-10 rounded-full bg-purple-100 text-purple-600 text-lg mr-4">
          üíé
        </span>
        <h2 class="text-lg font-medium text-gray-900">Step 1: Install the Gem</h2>
      </div>

      <p class="text-gray-600 mb-4">Add the ActiveRabbit gem to your Rails application's Gemfile:</p>

      <!-- Gemfile Code -->
      <div class="bg-gray-900 rounded-lg p-4 mb-6">
        <div class="flex items-center justify-between mb-2">
          <span class="text-gray-400 text-sm">Gemfile</span>
          <button onclick="copyToClipboard('gemfile-code')" class="text-gray-400 hover:text-white text-sm">
            üìã Copy
          </button>
        </div>
        <pre id="gemfile-code" class="text-green-400 text-sm"><code>gem 'activerabbit-ai'</code></pre>
      </div>

      <p class="text-gray-600 mb-4">Then run bundle install:</p>

      <!-- Bundle Install Command -->
      <div class="bg-gray-900 rounded-lg p-4 mb-6">
        <div class="flex items-center justify-between mb-2">
          <span class="text-gray-400 text-sm">Terminal</span>
          <button onclick="copyToClipboard('bundle-code')" class="text-gray-400 hover:text-white text-sm">
            üìã Copy
          </button>
        </div>
        <pre id="bundle-code" class="text-green-400 text-sm"><code>bundle install</code></pre>
      </div>

      <!-- Configuration Step -->
      <div class="flex items-center mb-6 pt-6 border-t border-gray-200">
        <span class="inline-flex items-center justify-center h-10 w-10 rounded-full bg-blue-100 text-blue-600 text-lg mr-4">
          ‚öôÔ∏è
        </span>
        <h2 class="text-lg font-medium text-gray-900">Step 2: Configure the Gem</h2>
      </div>

      <p class="text-gray-600 mb-4">Create an initializer file to configure ActiveRabbit:</p>

      <!-- Initializer Code -->
      <div class="bg-gray-900 rounded-lg p-4 mb-6">
        <div class="flex items-center justify-between mb-2">
          <span class="text-gray-400 text-sm">config/initializers/activerabbit.rb</span>
          <button onclick="copyToClipboard('initializer-code')" class="text-gray-400 hover:text-white text-sm">
            üìã Copy
          </button>
        </div>
        <pre id="initializer-code" class="text-green-400 text-sm"><code>ActiveRabbit::Client.configure do |config|
  config.api_key = "<%= @project.api_token %>"

  # Enable monitoring features
  config.enable_performance_monitoring = true
  config.enable_n_plus_one_detection = true
  config.enable_pii_scrubbing = true

  config.ignore_404 = false
end</code></pre>
      </div>

      <!-- Environment Variables Alternative -->
      <div class="bg-blue-50 rounded-lg p-4 mb-6">
        <div class="flex">
          <div class="flex-shrink-0">
            <span class="text-blue-500 text-xl">üí°</span>
          </div>
          <div class="ml-4">
            <h3 class="text-sm font-medium text-blue-900 mb-2">Alternative: Use Environment Variables</h3>
            <p class="text-sm text-blue-800 mb-3">You can also configure using environment variables:</p>
            <div class="bg-white rounded border p-3">
              <pre class="text-xs text-gray-700"><code>ACTIVERABBIT_API_KEY=<%= @project.api_token %></code></pre>
            </div>
          </div>
        </div>
      </div>

      <!-- Test Step -->
      <div class="flex items-center mb-6 pt-6 border-t border-gray-200">
        <span class="inline-flex items-center justify-center h-10 w-10 rounded-full bg-green-100 text-green-600 text-lg mr-4">
          üß™
        </span>
        <h2 class="text-lg font-medium text-gray-900">Step 3: Test the Integration</h2>
      </div>

      <p class="text-gray-600 mb-4">Restart your Rails application and trigger an error to test the connection:</p>

      <!-- Test Code -->
      <div class="bg-gray-900 rounded-lg p-4 mb-6">
        <div class="flex items-center justify-between mb-2">
          <span class="text-gray-400 text-sm">Rails Console or Controller</span>
          <button onclick="copyToClipboard('test-code')" class="text-gray-400 hover:text-white text-sm">
            üìã Copy
          </button>
        </div>
        <pre id="test-code" class="text-green-400 text-sm"><code># Test error tracking
ActiveRabbit::Client.track_exception(StandardError.new("Test error from ActiveRabbit!"))

# Test performance tracking
ActiveRabbit::Client.track_performance("test_operation", 100, { custom: "data" })</code></pre>
      </div>

      <!-- Verify Button -->
      <div class="pt-6 border-t border-gray-200">
        <%= form_with url: onboarding_verify_gem_path(@project), method: :post, local: true do |form| %>
          <div class="flex items-center justify-between">
            <% if current_user.projects.count > 1 %>
              <%= link_to dashboard_path,
                  class: "text-sm text-gray-500 hover:text-gray-700" do %>
                ‚Üê Back to dashboard
              <% end %>
            <% else %>
              <%= link_to onboarding_new_project_path,
                  class: "text-sm text-gray-500 hover:text-gray-700" do %>
                ‚Üê Back to project setup
              <% end %>
            <% end %>

            <%= form.submit "Verify Installation ‚úì",
                class: "inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500",
                data: { confirm: "Make sure you've installed the gem and restarted your Rails application. Click OK to test the connection." } %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Help Sidebar -->
  <div class="lg:col-span-1">
    <!-- Project Info -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
      <h3 class="text-lg font-medium text-gray-900 mb-4">Project Details</h3>
      <dl class="space-y-3">
        <div>
          <dt class="text-sm font-medium text-gray-500">Project Name</dt>
          <dd class="text-sm text-gray-900"><%= @project.name %></dd>
        </div>
        <div>
          <dt class="text-sm font-medium text-gray-500">Project ID</dt>
          <dd class="text-sm text-gray-900 font-mono"><%= @project.id %></dd>
        </div>
        <div>
          <dt class="text-sm font-medium text-gray-500">API Token</dt>
          <dd class="text-sm text-gray-900 font-mono break-all">
            <span id="api-token" class="blur-sm hover:blur-none transition-all cursor-pointer"
                  title="Click to reveal">
              <%= @project.api_token %>
            </span>
          </dd>
        </div>
      </dl>
    </div>

    <!-- Troubleshooting -->
    <div class="bg-yellow-50 rounded-lg p-6 mb-6">
      <div class="flex">
        <div class="flex-shrink-0">
          <span class="text-yellow-600 text-xl">‚ö†Ô∏è</span>
        </div>
        <div class="ml-4">
          <h3 class="text-sm font-medium text-yellow-800 mb-2">Troubleshooting</h3>
          <ul class="text-sm text-yellow-700 space-y-1">
            <li>‚Ä¢ Make sure to restart your Rails server after installation</li>
            <li>‚Ä¢ Check that your API token is correctly configured</li>
            <li>‚Ä¢ Verify your application can reach <%= request.base_url %></li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Need Help -->
    <div class="bg-gray-50 rounded-lg p-6">
      <div class="text-center">
        <h3 class="text-sm font-medium text-gray-900 mb-2">Need Help?</h3>
        <p class="text-xs text-gray-600 mb-3">
          Having trouble with the installation?
        </p>
        <a href="#" class="text-sm font-medium text-purple-600 hover:text-purple-700">
          View Documentation ‚Üí
        </a>
      </div>
    </div>
  </div>
</div>

<script>
function copyToClipboard(elementId) {
  const element = document.getElementById(elementId);
  const text = element.textContent;

  navigator.clipboard.writeText(text).then(function() {
    // Show feedback
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = '‚úÖ Copied!';
    setTimeout(() => {
      button.textContent = originalText;
    }, 2000);
  });
}
</script>

<% end %>
