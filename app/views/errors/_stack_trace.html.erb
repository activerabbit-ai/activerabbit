<%#
  Stack trace partial - Sentry-like display
  Expects: @selected_event or event (with backtrace)
  Source code context comes from the client gem's structured_stack_trace
%>
<% event = local_assigns[:event] || @selected_event || @events&.first %>
<% return unless event %>

<%# Parse backtrace - will use client's structured_stack_trace if available %>
<% frames = parse_backtrace(event) %>
<% culprit_frame = find_culprit_frame(frames) %>
<% app_frames = frames.select { |f| f[:in_app] } %>
<% lib_frames = frames.reject { |f| f[:in_app] } %>

<div class="stack-trace" data-controller="stack-trace" data-stack-trace-filter-value="app">
  <!-- AI Summary Collapsible - Header always visible -->
  <% if @issue&.ai_summary.present? %>
    <div id="ai-summary-panel" class="mb-5" data-ai-inline-target="panel">
      <div class="bg-gradient-to-br from-slate-50 to-indigo-50/30 border border-slate-200 rounded-xl overflow-hidden shadow-sm">
        <!-- Header - always visible, clickable to toggle -->
        <div class="bg-gradient-to-r from-indigo-600 to-violet-600 px-5 py-3 flex items-center justify-between cursor-pointer"
             data-action="click->ai-inline#toggle">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center">
              <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
              </svg>
            </div>
            <div>
              <h4 class="text-white font-semibold text-sm">AI Analysis</h4>
              <p class="text-indigo-100 text-xs">Powered by GPT-5.2</p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <% regenerate_url = if @current_project
                                  "/#{@current_project.slug}/errors/#{@issue.id}/regenerate_ai_summary"
                                elsif @project
                                  regenerate_ai_summary_project_error_path(@project, @issue)
                                else
                                  regenerate_ai_summary_error_path(@issue)
                                end %>
            <%= link_to regenerate_url, method: :post, class: "inline-flex items-center px-3 py-1.5 text-xs font-medium text-white/90 hover:text-white hover:bg-white/10 rounded-md transition-colors", data: { turbo_method: :post }, onclick: "event.stopPropagation();" do %>
              <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              Regenerate
            <% end %>
            <!-- Chevron indicator -->
            <svg class="w-5 h-5 text-white/70 transform transition-transform" data-ai-inline-target="chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </div>
        </div>
        <!-- Content - hidden by default, full height when open -->
        <div class="hidden" data-ai-inline-target="content">
          <div class="p-5">
            <div class="ai-summary-content text-sm">
              <%= render_ai_summary(@issue.ai_summary) %>
            </div>
          </div>
          <% if @issue.ai_summary_generated_at %>
            <div class="px-5 py-2 bg-slate-100 border-t border-slate-200">
              <p class="text-xs text-slate-500 flex items-center gap-1.5">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Generated <%= time_ago_in_words(@issue.ai_summary_generated_at) %> ago
              </p>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Filter Buttons (Sentry-style) -->
  <div class="flex items-center gap-2 mb-4">
    <div class="inline-flex rounded-lg border border-gray-300 overflow-hidden">
      <button type="button"
              class="filter-btn px-4 py-2 text-sm font-medium bg-indigo-600 text-white"
              data-action="click->stack-trace#filterFrames"
              data-stack-trace-target="filterBtn"
              data-filter="app">
        App Only
        <span class="ml-1 px-1.5 py-0.5 rounded bg-indigo-500 text-xs"><%= app_frames.count %></span>
      </button>
      <button type="button"
              class="filter-btn px-4 py-2 text-sm font-medium bg-white text-gray-700 hover:bg-gray-50 border-l border-gray-300"
              data-action="click->stack-trace#filterFrames"
              data-stack-trace-target="filterBtn"
              data-filter="full">
        Full
        <span class="ml-1 px-1.5 py-0.5 rounded bg-gray-200 text-xs"><%= frames.count %></span>
      </button>
    </div>
    <span class="text-sm text-gray-500 ml-2">
      <%= app_frames.count %> app â€¢ <%= lib_frames.count %> library frames
    </span>
  </div>

  <!-- Stack Frames -->
  <div class="border border-gray-200 rounded-lg overflow-hidden" data-stack-trace-target="frameList">
    <% frames.each_with_index do |frame, index| %>
      <% is_first = index == 0 %>
      <% is_last = index == frames.length - 1 %>
      <% is_culprit = culprit_frame && frame[:raw] == culprit_frame[:raw] %>
      <% source_context = frame[:source_context] %>

      <div class="stack-frame <%= is_first ? '' : 'border-t border-gray-200' %>"
           data-stack-trace-target="frame"
           data-in-app="<%= frame[:in_app] %>"
           data-expanded="<%= is_culprit || is_first %>">

        <!-- Frame Header (always visible) -->
        <div class="frame-header flex items-center justify-between px-4 py-3 cursor-pointer hover:bg-gray-50 transition-colors <%= is_culprit ? 'bg-red-50' : 'bg-white' %>"
             data-action="click->stack-trace#toggleFrame">
          <div class="flex items-center gap-3 min-w-0 flex-1">
            <!-- Expand/Collapse Icon -->
            <svg class="expand-icon w-4 h-4 text-gray-400 transition-transform flex-shrink-0"
                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>

            <!-- File Path -->
            <div class="flex items-center gap-2 min-w-0">
              <span class="font-mono text-sm <%= frame[:in_app] ? 'text-gray-800 font-medium' : 'text-gray-500' %> truncate">
                <%= frame[:file] || frame[:raw] %>
              </span>

              <% if frame[:in_app] %>
                <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-semibold bg-indigo-100 text-indigo-700 flex-shrink-0">
                  In App
                </span>
              <% end %>

              <% type_label = frame_type_label(frame[:frame_type]) %>
              <% if type_label && type_label != "Gem" %>
                <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium <%= frame_type_badge_class(frame[:frame_type]) %> flex-shrink-0">
                  <%= type_label %>
                </span>
              <% end %>
            </div>
          </div>

          <div class="flex items-center gap-3 flex-shrink-0 ml-4">
            <!-- Method name -->
            <% if frame[:method] %>
              <span class="text-sm text-gray-500">in</span>
              <code class="text-sm font-mono <%= frame[:in_app] ? 'text-indigo-600' : 'text-gray-500' %>">
                <%= clean_method_name(frame[:method]) %>
              </code>
            <% end %>

            <!-- Line number -->
            <% if frame[:line] %>
              <span class="text-sm text-gray-500">at line</span>
              <span class="text-sm font-mono font-semibold <%= is_culprit ? 'text-red-600' : 'text-gray-700' %>">
                <%= frame[:line] %>
              </span>
            <% end %>
          </div>
        </div>

        <!-- Frame Content (code context) - collapsible -->
        <div class="frame-content <%= (is_culprit || is_first) && source_context ? '' : 'hidden' %>">
          <% if source_context && source_context[:file_exists] %>
            <div class="bg-gray-900 text-gray-100 overflow-x-auto">
              <table class="w-full font-mono text-sm">
                <tbody>
                  <!-- Lines before -->
                  <% source_context[:lines_before].each do |line_info| %>
                    <tr class="hover:bg-gray-800">
                      <td class="px-3 py-0.5 text-right text-gray-500 select-none w-12 border-r border-gray-700">
                        <%= line_info[:number] %>
                      </td>
                      <td class="px-4 py-0.5 whitespace-pre"><%= h(line_info[:content]) %></td>
                    </tr>
                  <% end %>

                  <!-- Error line (highlighted) -->
                  <tr class="bg-red-900/40 border-l-4 border-red-500">
                    <td class="px-3 py-0.5 text-right text-red-300 font-bold select-none w-12 border-r border-gray-700">
                      <%= source_context[:line_content][:number] %>
                    </td>
                    <td class="px-4 py-0.5 whitespace-pre text-white"><%= h(source_context[:line_content][:content]) %></td>
                  </tr>

                  <!-- Lines after -->
                  <% source_context[:lines_after].each do |line_info| %>
                    <tr class="hover:bg-gray-800">
                      <td class="px-3 py-0.5 text-right text-gray-500 select-none w-12 border-r border-gray-700">
                        <%= line_info[:number] %>
                      </td>
                      <td class="px-4 py-0.5 whitespace-pre"><%= h(line_info[:content]) %></td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% elsif frame[:in_app] && !source_context %>
            <div class="px-4 py-3 bg-gray-50 text-sm text-gray-500 italic">
              Source code context not available. Update activerabbit-ai gem to latest version for source capture.
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <% if frames.empty? %>
      <div class="px-4 py-6 text-center text-gray-500">
        No stack trace available
      </div>
    <% end %>
  </div>

  <!-- Show/Hide all frames toggle -->
  <% non_app_frames = frames.reject { |f| f[:in_app] } %>
  <% if non_app_frames.any? %>
    <div class="mt-3 flex items-center justify-between text-sm">
      <span class="text-gray-500">
        <%= frames.count { |f| f[:in_app] } %> app frames, <%= non_app_frames.count %> library frames
      </span>
      <button type="button"
              class="text-indigo-600 hover:text-indigo-800 font-medium"
              data-action="click->stack-trace#toggleAllFrames"
              data-stack-trace-target="toggleButton">
        Expand all frames
      </button>
    </div>
  <% end %>
</div>
